import sqlite3
from datetime import datetime
import os
import getpass

# ===== Cáº¤U HÃŒNH =====
DB_NAME = "business_data.db"
PASSWORD = "0102"  # Máº­t kháº©u xÃ³a doanh nghiá»‡p

# ===== KHá»I Táº O DATABASE =====
def init_db():
    """Khá»Ÿi táº¡o database vá»›i cáº¥u trÃºc chuáº©n"""
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS businesses (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL,
                tax_id TEXT UNIQUE NOT NULL,
                address TEXT,
                phone TEXT,
                email TEXT,
                industry TEXT,
                contact_person TEXT,
                notes TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP)''')
    conn.commit()
    conn.close()

# ===== CÃC HÃ€M CHá»¨C NÄ‚NG CHÃNH =====
def add_business():
    """ThÃªm doanh nghiá»‡p má»›i vá»›i kiá»ƒm tra dá»¯ liá»‡u"""
    print("\nâ• THÃŠM DOANH NGHIá»†P Má»šI")
    try:
        business_data = (
            input("TÃªn doanh nghiá»‡p: ").strip(),
            input("MÃ£ sá»‘ thuáº¿ (báº¯t buá»™c): ").strip(),
            input("Äá»‹a chá»‰: ").strip(),
            input("Sá»‘ Ä‘iá»‡n thoáº¡i: ").strip(),
            input("Email: ").strip(),
            input("NgÃ nh nghá»: ").strip(),
            input("NgÆ°á»i liÃªn há»‡: ").strip(),
            input("Ghi chÃº: ").strip()
        )

        if not all([business_data[0], business_data[1]]):
            print("âŒ TÃªn vÃ  MST khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng!")
            return

        conn = sqlite3.connect(DB_NAME)
        c = conn.cursor()
        c.execute('''INSERT INTO businesses 
                    (name, tax_id, address, phone, email, industry, contact_person, notes)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?)''', business_data)
        conn.commit()
        print("âœ… ThÃªm thÃ nh cÃ´ng!")
    except sqlite3.IntegrityError:
        print("âŒ Lá»—i: MST Ä‘Ã£ tá»“n táº¡i!")
    except Exception as e:
        print(f"âŒ Lá»—i há»‡ thá»‘ng: {type(e).__name__}: {e}")
    finally:
        conn.close()

def search_business():
    """TÃ¬m kiáº¿m theo tá»«ng trÆ°á»ng cá»¥ thá»ƒ"""
    while True:
        print("\n" + "="*50)
        print("ğŸ” TÃŒM KIáº¾M DOANH NGHIá»†P".center(50))
        print("="*50)
        print("1. TÃ¬m theo TÃŠN doanh nghiá»‡p (chÃ­nh xÃ¡c)")
        print("2. TÃ¬m theo MÃƒ Sá» THUáº¾ (chÃ­nh xÃ¡c)")
        print("3. TÃ¬m theo NGÃ€NH NGHá»€ (chÃ­nh xÃ¡c)")
        print("4. TÃ¬m theo NGÆ¯á»œI LIÃŠN Há»† (chÃ­nh xÃ¡c)")
        print("5. TÃ¬m theo Sá» ÄIá»†N THOáº I (chÃ­nh xÃ¡c)")
        print("6. TÃ¬m theo EMAIL (chÃ­nh xÃ¡c)")
        print("7. TÃ¬m theo Äá»ŠA CHá»ˆ (chá»©a tá»« khÃ³a)")
        print("0. Quay láº¡i menu chÃ­nh")
        print("="*50)

        choice = input("ğŸ‘‰ Chá»n loáº¡i tÃ¬m kiáº¿m (0-7): ").strip()

        if choice == "0":
            return

        field_map = {
            "1": ("name", "TÃŠN DOANH NGHIá»†P"),
            "2": ("tax_id", "MÃƒ Sá» THUáº¾"),
            "3": ("industry", "NGÃ€NH NGHá»€"),
            "4": ("contact_person", "NGÆ¯á»œI LIÃŠN Há»†"),
            "5": ("phone", "Sá» ÄIá»†N THOáº I"),
            "6": ("email", "EMAIL"),
            "7": ("address", "Äá»ŠA CHá»ˆ")
        }

        if choice not in field_map:
            print("âš ï¸ Lá»±a chá»n khÃ´ng há»£p lá»‡! Vui lÃ²ng chá»n tá»« 0-7")
            continue

        field_name, field_label = field_map[choice]
        search_term = input(f"\nNháº­p {field_label} cáº§n tÃ¬m: ").strip()

        try:
            conn = sqlite3.connect(DB_NAME)
            c = conn.cursor()
            
            # RiÃªng Ä‘á»‹a chá»‰ dÃ¹ng LIKE, cÃ¡c trÆ°á»ng khÃ¡c dÃ¹ng =
            if field_name == "address":
                query = f"SELECT * FROM businesses WHERE {field_name} LIKE ?"
                params = (f"%{search_term}%",)
            else:
                query = f"SELECT * FROM businesses WHERE {field_name} = ?"
                params = (search_term,)

            c.execute(query, params)
            results = c.fetchall()

            if not results:
                print(f"\nğŸ” KhÃ´ng tÃ¬m tháº¥y doanh nghiá»‡p nÃ o cÃ³ {field_label}: '{search_term}'")
                continue

            print(f"\nğŸ“Š Káº¾T QUáº¢ TÃŒM KIáº¾M THEO {field_label.upper()}:")
            for idx, biz in enumerate(results, 1):
                print(f"\n{'='*50}")
                print(f"DOANH NGHIá»†P #{idx}")
                print(f"{'='*50}")
                print(f"ğŸ¢ TÃªn: {biz[1]}")
                print(f"ğŸ“Œ MST: {biz[2]}")
                print(f"ğŸ“ Äá»‹a chá»‰: {biz[3]}")
                print(f"ğŸ“ Äiá»‡n thoáº¡i: {biz[4]}")
                print(f"âœ‰ï¸ Email: {biz[5]}")
                print(f"ğŸ­ NgÃ nh nghá»: {biz[6]}")
                print(f"ğŸ‘¤ NgÆ°á»i liÃªn há»‡: {biz[7]}")
                print(f"ğŸ“ Ghi chÃº: {biz[8]}")
                print(f"â° NgÃ y táº¡o: {biz[9]}")
                print(f"{'='*50}")

        except Exception as e:
            print(f"âŒ Lá»—i khi tÃ¬m kiáº¿m: {e}")
        finally:
            conn.close()

        # Há»i cÃ³ muá»‘n tiáº¿p tá»¥c tÃ¬m kiáº¿m khÃ´ng
        if input("\nBáº¡n cÃ³ muá»‘n tiáº¿p tá»¥c tÃ¬m kiáº¿m? (y/n): ").lower() != 'y':
            break

# ===== MENU CHÃNH =====
def main_menu():
    init_db()
    while True:
        print("\n" + "="*50)
        print("PHáº¦N Má»€M QUáº¢N LÃ DOANH NGHIá»†P".center(50))
        print("="*50)
        print("1. ThÃªm doanh nghiá»‡p")
        print("2. TÃ¬m kiáº¿m doanh nghiá»‡p")  # Sáº½ gá»i hÃ m search_business() má»›i
        print("3. XÃ³a doanh nghiá»‡p (yÃªu cáº§u máº­t kháº©u)")
        print("0. ThoÃ¡t")
        print("="*50)

        choice = input("ğŸ‘‰ Chá»n chá»©c nÄƒng (0-3): ").strip()

        if choice == "1":
            add_business()
        elif choice == "2":
            search_business()  # Gá»i hÃ m tÃ¬m kiáº¿m má»›i
        elif choice == "3":
            delete_business()
        elif choice == "0":
            print("\nğŸ‘‹ ÄÃ£ Ä‘Ã³ng chÆ°Æ¡ng trÃ¬nh. Dá»¯ liá»‡u Ä‘Æ°á»£c lÆ°u táº¡i:")
            print(f"- {os.path.abspath(DB_NAME)}")
            break
        else:
            print("âš ï¸ Vui lÃ²ng chá»n tá»« 0-3")

if __name__ == "__main__":
    main_menu()